<html>
	<title>Test</title>
	<script type="text/javascript" src="javascripts/prototype.js"></script>
	<script type="text/javascript" src="javascripts/scriptaculous.js?load=effects"></script>
	<style>
		body{
			font-size:1.3em;
		}

		.dragging{
			background-color:yellow !important;
			position:relative;
			opacity:0.75;
			z-index:100;
		}
		
		.dragging .dragger{
			background-color:#000;
		}
				
		.dragger{
			height:30px;
			width:30px;
			display:block;
			float:right;
			background-color:#aaa;
		}
		
		#sortable_list {
			padding:0;margin:0;
			background-color:#aaa;
		}
		
		#sortable_list li{
			background-color:#fff;
			position:relative;
			height:30px;
			list-style:none;
			padding:0;margin:0;
			line-height:30px;
		}
	</style>
	
	<meta name="viewport" content="initial-scale=2.3, user-scalable=no" />
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
	
	<body>
		<ul id="sortable_list">
			<li>
				Item 1 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
			<li>
				Item 2 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
			<li>
				Item 3 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
			<li>
				Item 4 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
			<li>
				Item 5 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
			<li>
				Item 6 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
			<li>
				Item 7 : position 
				<span class="position">1</span>
				<span class="dragger"></span> 
			</li>
		</ul>
		<pre id="console"></pre>
		
		<script>
			$draggedElement = null;
			$draggedOffset = {x : 0, y : 0};		
			$draggableParentOffset = {x : 0, y : 0};
			$draggedPosition = null;
			$draggedDimensions = {width : 0, height : 0};
			function setDraggedElement(el, event){
				$draggedDimensions = el.getDimensions();
				el.style.width = $draggedDimensions.width+'px';
				$draggedElement = el;
				$(el).addClassName('dragging');
				var xy = el.positionedOffset();
				$draggedOffset.x = event.touches[0].clientX - xy[0];
				$draggedOffset.y = event.touches[0].clientY - xy[1];				
				var xy = el.parentNode.positionedOffset();
				var wh = el.parentNode.getDimensions();
				$draggableParentRect = {x : xy[0], y : xy[1], w : wh.width, h : wh.height};
			}
			
			function log(msg){
				$('console').insert({top : msg + "\n"});
			}
			
			function repositionDraggedElement(clientY){
				// Determine where the node should go
				var next = { element : null, position : null };
				var lis = $draggedElement.parentNode.select('li');
				var nodesBefore = 0;
				
				for(var l=0;l<lis.length;l++){
					var li = lis[l];
					if(li != $draggedElement){
						// this has to be relative to the parent
						var liY = li.positionedOffset()[1] - $draggableParentRect.y;
						var liDimensions = li.getDimensions();
						// Find the element that is closest to the dropped element
						if(liY + (liDimensions.height * 0.5) > clientY){									
							if(!next.position || liY < next.position){
								next.element = li;
								next.position = liY;
							}
						}else{
							nodesBefore++;
						}
					}
				}		
				// out position == nodesBefore
				var container = $draggedElement.parentNode;
				if(nodesBefore != 0){							
					container.insertBefore($draggedElement, next.element);
				}else{
					container.insertBefore($draggedElement, container.firstChild);
				}
				// Send the position to someone
				$draggedPosition = nodesBefore;
				log('new position is '+nodesBefore);				
			}
			
			document.observe('dom:loaded', function(){
				document.ontouchmove = function(e){
					if($draggedElement){
						e.preventDefault();
											
						repositionDraggedElement(e.touches[0].clientY - $draggableParentRect.y);
						
						var y = e.touches[0].clientY - $draggableParentRect.y;
						var elY = y - ($draggedPosition * $draggedDimensions.height) - $draggedOffset.y;

						// This prevents the li from going over the edges of the container.
						if(elY <= $draggedDimensions.height && elY >= $draggedDimensions.height * -1){
							$draggedElement.style.top = elY+'px';
						}
						repositionDraggedElement(e.touches[0].clientY - $draggableParentRect.y);
					}
				}
				document.ontouchend = function(e){
					if($draggedElement){
						e.preventDefault();
						$($draggedElement).removeClassName('dragging');						
						$draggedElement.style.top = null;
						$draggedElement.style.left = null;						
						$draggedElement.style.width = null;
						new Effect.Highlight($draggedElement, { startcolor : '#ffff00', duration : 0.2});
					}					
					$draggedElement = null;
				}				
				
				// Observe the drag
				$$('.dragger').each(function(el,i){
					el.ontouchmove = function(e){
						e.preventDefault();
					}
					el.ontouchstart = function(e){
						e.preventDefault();						
						setDraggedElement(this.parentNode, e);
					}
					el.ontouchend = function(e){				
						e.preventDefault();								
					}				
				});
				
			});			
		</script>
	</body>
</html>